name: Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run tests
        run: |
          gotestsum \
            --junitfile test-results.xml \
            -- ./... -count=1

      - name: Generate Cucumber report
        env:
          CUCUMBER_REPORT: ${{ github.workspace }}/cucumber-report.json
        run: go test ./features/steps/... -count=1

      - name: Upload test reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-reports
          path: |
            test-results.xml
            cucumber-report.json

  release:
    name: Build & Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Download test reports
        uses: actions/download-artifact@v7
        with:
          name: test-reports
          path: reports/

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: secrets.DOCKERHUB_TOKEN != '' && vars.DOCKERHUB_USERNAME != ''
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2.13"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ github.token }}
          DISTRIBUTION_REPO_TOKEN: ${{ secrets.DISTRIBUTION_REPO_TOKEN }}

      - name: Attach test reports to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            reports/test-results.xml \
            reports/cucumber-report.json \
            --clobber

  npm:
    name: Publish NPM Packages
    needs: release
    runs-on: ubuntu-latest
    if: secrets.NPM_TOKEN != ''
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p /tmp/release-assets
          gh release download "${{ github.event.release.tag_name }}" \
            --pattern "ailign_${VERSION}_*.tar.gz" \
            --pattern "ailign_${VERSION}_*.zip" \
            --dir /tmp/release-assets

      - name: Copy binaries into platform packages
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail

          copy_binary() {
            local pkg_dir="$1" os="$2" arch="$3" ext="$4" bin_name="$5"
            local archive="ailign_${VERSION}_${os}_${arch}.${ext}"
            mkdir -p "${pkg_dir}/bin"
            if [ "$ext" = "tar.gz" ]; then
              tar xzf "/tmp/release-assets/${archive}" -C "${pkg_dir}/bin" "${bin_name}"
            else
              unzip -o "/tmp/release-assets/${archive}" "${bin_name}" -d "${pkg_dir}/bin"
            fi
            chmod +x "${pkg_dir}/bin/${bin_name}"
          }

          copy_binary npm/ailign-darwin-arm64 darwin arm64 tar.gz ailign
          copy_binary npm/ailign-darwin-x64   darwin amd64 tar.gz ailign
          copy_binary npm/ailign-linux-x64    linux  amd64 tar.gz ailign
          copy_binary npm/ailign-linux-arm64  linux  arm64 tar.gz ailign
          copy_binary npm/ailign-win32-x64    windows amd64 zip  ailign.exe

      - name: Set package versions
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          for pkg_dir in npm/ailign npm/ailign-darwin-arm64 npm/ailign-darwin-x64 \
                         npm/ailign-linux-x64 npm/ailign-linux-arm64 npm/ailign-win32-x64; do
            cd "$pkg_dir"
            npm version "$VERSION" --no-git-tag-version --allow-same-version
            cd "${{ github.workspace }}"
          done

          # Update optionalDependencies versions in main package
          cd npm/ailign
          node -e "
            const pkg = require('./package.json');
            for (const dep of Object.keys(pkg.optionalDependencies)) {
              pkg.optionalDependencies[dep] = '${VERSION}';
            }
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg_dir in npm/ailign-darwin-arm64 npm/ailign-darwin-x64 \
                         npm/ailign-linux-x64 npm/ailign-linux-arm64 npm/ailign-win32-x64; do
            cd "$pkg_dir"
            npm publish --access public
            cd "${{ github.workspace }}"
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/ailign
          npm publish --access public
