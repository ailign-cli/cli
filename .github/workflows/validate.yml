name: Validate

on:
  workflow_call:

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - uses: golangci/golangci-lint-action@v9.2.0
        with:
          version-file: .golangci-lint-version

  goreleaser:
    name: GoReleaser Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2.13"
          args: check

  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run unit and BDD tests
        env:
          JUNIT_REPORT: ${{ github.workspace }}/bdd-results.xml
        run: gotestsum --junitfile test-results.xml -- ./... -count=1

      - name: Unit test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Test Results
          path: test-results.xml
          reporter: java-junit

      - name: BDD test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: BDD Test Results
          path: bdd-results.xml
          reporter: java-junit
