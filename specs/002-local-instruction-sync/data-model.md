# Data Model: Local Instruction Sync

**Feature**: 002-local-instruction-sync
**Date**: 2026-02-17

## Entities

### Config (updated)

Extends the existing `Config` struct from feature 001.

| Field          | Type       | Required | Validation                     |
|----------------|------------|----------|--------------------------------|
| `targets`      | `[]string` | Yes      | Non-empty, known target names, unique |
| `local_overlays` | `[]string` | No     | Relative paths, no traversal above working dir, non-empty strings |

**Validation Rules**:
- `local_overlays` items must be non-empty strings
- Paths must be relative (no absolute paths)
- Paths must not traverse above the working directory (`../` that
  escapes repo root is rejected)
- Paths are validated for existence at sync time (not at config
  parse time)

**Example**:
```yaml
targets:
  - claude
  - cursor
  - copilot
local_overlays:
  - .ai-instructions/base.md
  - .ai-instructions/project-context.md
```

### Target (interface)

Each target encapsulates knowledge of where a specific AI tool
expects its instruction file.

| Method              | Returns  | Description                          |
|---------------------|----------|--------------------------------------|
| `Name()`            | `string` | Target identifier (e.g., "claude")   |
| `InstructionPath()` | `string` | Relative output path for this target |

**Known Implementations**:

| Target   | Name       | InstructionPath                    |
|----------|------------|------------------------------------|
| Claude   | `claude`   | `.claude/instructions.md`          |
| Cursor   | `cursor`   | `.cursorrules`                     |
| Copilot  | `copilot`  | `.github/copilot-instructions.md`  |
| Windsurf | `windsurf` | `.windsurfrules`                   |

All targets symlink to the same hub file
(`.ailign/instructions.md`). There is no per-target rendering —
content is written once to the hub. When per-target content
differentiation is needed, a `Render()` method can be added to
the interface.

### Registry

Holds all available target implementations. Used by the sync engine
and the config validator.

| Method                 | Returns           | Description                    |
|------------------------|-------------------|--------------------------------|
| `Register(t Target)`  | -                 | Add target to registry         |
| `Get(name string)`    | `Target, bool`    | Look up target by name         |
| `IsValid(name string)` | `bool`           | Check if name is registered    |
| `KnownTargets()`      | `[]string`        | List all registered names      |

**Invariant**: The set of registered targets MUST match the enum in
`schema.json`. A test verifies this.

### SyncResult

Outcome of a sync operation, used for CLI output formatting.

| Field     | Type             | Description                         |
|-----------|------------------|-------------------------------------|
| `HubPath` | `string`        | Path to hub file                    |
| `HubStatus` | `string`      | `written` or `unchanged`            |
| `Links`   | `[]LinkResult`  | Per-target symlink outcomes         |
| `Warnings`| `[]string`      | Diagnostic warnings (e.g., empty overlay files) |

> **Note**: `DryRun` field will be added in Phase 5 when dry-run behavior is implemented.

### LinkResult

Per-target symlink outcome within a sync operation.

| Field      | Type     | Description                              |
|------------|----------|------------------------------------------|
| `Target`   | `string` | Target name                              |
| `LinkPath` | `string` | Path to symlink (target instruction path)|
| `Status`   | `string` | `created`, `exists`, `replaced`, `error` |
| `Error`    | `string` | Error message if status is `error`       |

### ManagedContentHeader

Prepended to the hub file to indicate it is ailign-managed.

**Format** (Markdown HTML comment):
```markdown
<!-- DO NOT EDIT — Generated by ailign
   Source: .ai-instructions/base.md, .ai-instructions/project.md
   Regenerate: ailign sync
-->

```

**Fields**:
- Warning not to edit manually
- Source file list (from `local_overlays`)
- Command to regenerate

## Relationships

```
Config
  ├── targets[]  ──references──>  Registry  ──contains──>  Target[]
  └── local_overlays[]  ──references──>  Overlay files (filesystem)

ailign sync
  ├── reads Config
  ├── reads Overlay files
  ├── composes overlays (concatenate in order)
  ├── writes .ailign/instructions.md (hub file, atomic)
  ├── creates symlinks: Target.InstructionPath() → .ailign/instructions.md
  └── returns SyncResult
```

## State Transitions

The sync operation is stateless — it reads config and overlays,
writes the hub file and symlinks. There is no persistent state
between runs. Each sync is a complete reconciliation.

**Target file states**:
1. **Does not exist** → Symlink created
2. **Exists as symlink to our hub** → Hub content updated (no
   symlink change)
3. **Exists as symlink to elsewhere** → Replaced with our symlink
4. **Exists as regular file** → Replaced with symlink
5. **Exists but not writable** → Error reported with remediation
