# Feature Specification: Local Instruction Sync

**Feature Branch**: `002-local-instruction-sync`
**Created**: 2026-02-17
**Status**: Draft
**Input**: User description: "In order to be able to work with multiple AI models, As a developer, I want to be able to synchronize local AI instructions between different targets within the same directory"

## Scope

This feature covers **rendering local instruction content to
target-specific files** based on the `.ailign.yml` configuration. It
includes extending the config schema to support `local_overlays`. It
does NOT include:

- Package registry interaction (fetching remote packages) — separate
  feature
- Content tiers and size budgets — future enhancement
- `ailign diff` command — separate feature
- `ailign status` / drift detection — separate feature
- `ailign explain` / provenance tracking — separate feature
- `ailign init` / config generation — separate feature
- Intelligent merge or conflict resolution — out of scope per
  constitution

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Sync Local Instructions to Target Files (Priority: P1)

**In order to** maintain consistent AI instructions across multiple
tools
**As a** developer working in a repository
**I want to** sync my local instruction files to all configured target
formats with a single command

A developer maintains AI instructions in local Markdown files listed
under `local_overlays` in `.ailign.yml`. When they run `ailign sync`,
the CLI reads those files, composes them in the order listed, and
makes the result available at each configured target's instruction file. Each
output file includes a managed-content header indicating it is
generated by ailign and should not be edited manually.

The target file mappings are:

| Target   | Output Path                       |
|----------|-----------------------------------|
| claude   | `.claude/instructions.md`         |
| cursor   | `.cursorrules`                    |
| copilot  | `.github/copilot-instructions.md` |
| windsurf | `.windsurfrules`                  |

**Why this priority**: This is the core value proposition of ailign —
one source of truth rendered to multiple tools. Without this, the tool
provides no synchronization capability.

**Independent Test**: Can be fully tested by creating local overlay
files, configuring targets and overlays in `.ailign.yml`, running
`ailign sync`, and verifying the correct output files are generated
with the expected content.

**Acceptance Scenarios**: See [`features/sync-local-instructions.feature`](../../features/sync-local-instructions.feature)

| Scenario                                    | Description                                    |
|---------------------------------------------|------------------------------------------------|
| Sync single overlay to multiple targets     | All target files created with correct content   |
| Sync multiple overlays composed in order    | Overlays concatenated in config-defined order   |
| Missing overlay file produces error         | Clear error with file path, no files written    |
| Target directory created if missing         | e.g., `.claude/` created automatically          |
| Output files include managed-content header | Header indicates file is ailign-managed         |
| No local_overlays configured                | Clear error telling user to configure overlays  |
| Existing target file replaced with symlink  | Regular file replaced by symlink to hub         |

---

### User Story 2 - Preview Sync Without Modifying Files (Priority: P2)

**In order to** review changes before they are applied
**As a** developer
**I want to** preview what `ailign sync` would do without modifying any
files

Running `ailign sync --dry-run` shows which files would be created,
updated, or left unchanged. No files are modified. This supports the
Transparency principle — developers must understand what ailign will
do before it does it.

**Why this priority**: Trust requires transparency. Developers need to
verify sync behavior before allowing file modifications, especially
on first use or after changing their config.

**Independent Test**: Can be tested by running `ailign sync --dry-run`,
verifying output describes expected changes, and confirming no files on
disk were modified.

**Acceptance Scenarios**: See [`features/preview-sync-changes.feature`](../../features/preview-sync-changes.feature)

| Scenario                                  | Description                                 |
|-------------------------------------------|---------------------------------------------|
| Dry-run shows files that would be created | Lists each target file path and status      |
| Dry-run does not modify any files         | Target files remain unchanged after dry-run |
| Dry-run with no changes needed            | Reports all targets are up to date          |
| Dry-run output respects --format flag     | JSON and human-readable formats supported   |

---

### Edge Cases

- What happens when an overlay file is empty? The CLI MUST include it
  (as empty content) and produce a warning.
- What happens when an overlay file contains non-UTF-8 content? The
  CLI MUST report a clear encoding error with the file path.
- What happens when a target file is read-only? The CLI MUST report a
  permission error with the file path and remediation guidance.
- What happens when the target file has been manually edited? The CLI
  MUST overwrite it — the source of truth is the overlays. The
  managed-content header warns users not to edit manually.
- What happens when overlay paths use `../` to escape the repository
  root? The CLI MUST reject paths that traverse above the working
  directory.
- What happens when two overlays contain overlapping content? No
  conflict resolution — overlays are composed in the order listed.
  Developers control the order in their config.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: The `.ailign.yml` schema MUST support an optional
  `local_overlays` field containing a list of relative file paths.
- **FR-002**: The `ailign sync` command MUST read all files listed in
  `local_overlays` and compose them in the order listed.
- **FR-003**: The `ailign sync` command MUST render the composed
  content to each configured target's instruction file.
- **FR-004**: Target file mappings MUST be: claude →
  `.claude/instructions.md`, cursor → `.cursorrules`, copilot →
  `.github/copilot-instructions.md`, windsurf → `.windsurfrules`.
- **FR-005**: The CLI MUST create target directories if they do not
  exist (e.g., `.claude/`, `.github/`).
- **FR-006**: Each rendered target file MUST include a
  managed-content header indicating it was generated by ailign and
  should not be manually edited.
- **FR-007**: The hub file write MUST be atomic to prevent partial
  writes or corruption. Symlink failures for individual targets MUST
  be reported without affecting other targets or the hub file.
- **FR-008**: If any overlay file listed in `local_overlays` does not
  exist, the CLI MUST report an error with the file path and exit
  with code 2 without writing any files.
- **FR-009**: The `--dry-run` flag MUST show what files would be
  created or updated without modifying any files.
- **FR-010**: The `ailign sync` command MUST report results to stdout
  listing each target file and its status (created, updated,
  unchanged).
- **FR-011**: The CLI MUST reject overlay paths that traverse above
  the working directory.
- **FR-012**: The `ailign sync` command MUST exit with code 0 on
  success and code 2 on error.
- **FR-013**: The CLI MUST support both JSON and human-readable output
  for sync results (controlled by `--format` flag).
- **FR-014**: Running `ailign sync` with no `local_overlays`
  configured MUST report a clear error explaining that source files
  need to be specified.

### Key Entities

- **Local Overlay**: A Markdown file in the repository containing
  instruction content. Referenced by relative path in `.ailign.yml`.
  Multiple overlays are composed in order to form the complete
  instruction set.
- **Target**: An AI tool that ailign renders instructions for (claude,
  cursor, copilot, windsurf). Each target has a specific output file
  path and location.
- **Rendered Output**: The tool-specific instruction file generated by
  ailign from composed overlay content. Includes a managed-content
  header.
- **Managed-Content Header**: A marker at the top of each rendered
  file indicating it was generated by ailign, listing source files,
  and warning not to edit manually.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Syncing a 3-file overlay set to 4 targets completes in
  under 1 second.
- **SC-002**: 100% of configured targets receive the composed
  instruction content.
- **SC-003**: Developers can update instructions in one place and sync
  to all targets with a single command — zero manual copying.
- **SC-004**: Dry-run accurately predicts 100% of file changes that
  sync would make.
- **SC-005**: 100% of error conditions produce actionable messages
  with file paths and remediation guidance.

## Assumptions

- Local overlay files are plain Markdown (`.md`). Other formats are
  not supported in this feature.
- All targets receive the same composed content. Target-specific
  content filtering (content tiers) is a future enhancement.
- Size limits per target tool are not enforced in this feature.
  Size-aware rendering is a future enhancement.
- The managed-content header format uses a comment syntax appropriate
  for each target's file format.
- Overlay files are UTF-8 encoded.
- The `ailign sync` command operates on the current working directory
  only (consistent with config parsing behavior).
- Atomicity is implemented via a write-to-temporary-then-rename
  pattern.
- The `ailign sync` command is separate from `ailign pull` (which will
  fetch remote packages in a future feature).
- Windows symlink support is out of scope for this feature. Git on
  Windows defaults to `core.symlinks=false`, which checks out
  symlinks as plain text files. Windows users need
  `core.symlinks=true` and Developer Mode or admin privileges. This
  will be specified and addressed as a separate feature.
